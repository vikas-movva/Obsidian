<!doctype html><html lang=en-US><head><meta charset=utf-8><meta content="ie=edge" http-equiv=x-ua-compatible><meta content="width=device-width,initial-scale=1,shrink-to-fit=no" name=viewport><link href=https://fonts.googleapis.com rel=preconnect><link href=https://fonts.gstatic.com rel=preconnect><link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel=stylesheet><link href=https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css rel=stylesheet><link integrity="sha512-SJw7jzjMYJhsEnN/BuxTWXkezA2cRanuB8TdCNMXFJjxG9ZGSKOX5P3j03H6kdMxalKHZ7vlBMB4CagFP/de0A==" crossorigin=anonymous href=https://cdnjs.cloudflare.com/ajax/libs/hover.css/2.1.1/css/hover-min.css referrerpolicy=no-referrer rel=stylesheet><link integrity="sha512-RliK2gk03WxUELn57ddjWLhEfhUiOZ85VvWLImFy8A7FOPMkF4Z9YGQ3VKX5jpwkEerAL6I0nC+JNeCPrxWBTw==" crossorigin=anonymous href=https://cdnjs.cloudflare.com/ajax/libs/csshake/1.5.3/csshake.min.css referrerpolicy=no-referrer rel=stylesheet><script integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin=anonymous referrerpolicy=no-referrer src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js></script><link href=https://vikas-movva-obsidian.netlify.app/main.css rel=stylesheet><meta content="index, follow" name=robots><meta content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" name=googlebot><meta content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" name=bingbot><title>01 A Minimal Rust Kernel | Someone's Second ðŸ§ </title><meta name=description><link href=https://vikas-movva-obsidian.netlify.app/docs/projects/rust-os/notes/01-a-minimal-rust-kernel/ rel=canonical><script type=application/ld+json>
  {
    "@context": "http://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
      {
        "@type": "ListItem",
        "position":  1 ,
        "name": "Home",
        "item": "https://vikas-movva-obsidian.netlify.app/"
      }
    ]
  }
</script><meta content=#fff name=theme-color><link href=https://vikas-movva-obsidian.netlify.app/apple-touch-icon.png rel=apple-touch-icon sizes=180x180><link href=https://vikas-movva-obsidian.netlify.app/favicon-32x32.png rel=icon sizes=32x32 type=image/png><link href=https://vikas-movva-obsidian.netlify.app/favicon-16x16.png rel=icon sizes=16x16 type=image/png><link crossorigin=anonymous href=https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css integrity=sha384-KiWOvVjnN8qwAZbuQyWDIbfCLFhLXNETzBQjA/92pIowpC0d2O3nppDGQVgwd2nB rel=stylesheet><script crossorigin=anonymous defer integrity=sha384-0fdwu/T/EQMsQlrHCCHoH10pkPLlKA1jL5dFyUOvB3lfeT2540/2g6YgSi2BL14p src=https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js></script><script crossorigin=anonymous defer integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR src=https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/contrib/auto-render.min.js></script><script>document.addEventListener("DOMContentLoaded", function() {
		renderMathInElement(document.body, {
		delimiters: [
			{left: '$$', right: '$$', display: true},
			{left: '$', right: '$', display: false},
		],
		throwOnError : false
		});
	});</script><body class="docs single"><script>if (localStorage.getItem("theme") === "dark" || (!localStorage.getItem("theme") && window.matchMedia("(prefers-color-scheme: dark)").matches)) {
      document.body.classList.add("dark");
    }</script><div class="header-bar fixed-top"></div><header class="navbar fixed-top navbar-expand-md navbar-light"><div class=container><input class="menu-btn order-0" id=menu-btn type=checkbox><label class="menu-icon d-md-none" for=menu-btn><span class=navicon></span></label><a class="navbar-brand order-1 order-md-0 me-auto" href=https://vikas-movva-obsidian.netlify.app/>Someone's Second ðŸ§ </a><button aria-label="Toggle mode" class="btn btn-link order-2 order-md-4" id=mode type=button><span class=toggle-dark><svg class="feather feather-moon" viewbox="0 0 24 24" fill=none height=20 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=20 xmlns=http://www.w3.org/2000/svg><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg></span> <span class=toggle-light><svg class="feather feather-sun" viewbox="0 0 24 24" fill=none height=20 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=20 xmlns=http://www.w3.org/2000/svg><circle cx=12 cy=12 r=5></circle><line x1=12 x2=12 y1=1 y2=3></line><line x1=12 x2=12 y1=21 y2=23></line><line x1=4.22 x2=5.64 y1=4.22 y2=5.64></line><line x1=18.36 x2=19.78 y1=18.36 y2=19.78></line><line x1=1 x2=3 y1=12 y2=12></line><line x1=21 x2=23 y1=12 y2=12></line><line x1=4.22 x2=5.64 y1=19.78 y2=18.36></line><line x1=18.36 x2=19.78 y1=5.64 y2=4.22></line></svg></span></button><ul class="navbar-nav fork-me order-3 order-md-5"><li class=nav-item><a class=nav-link href=https://github.com/vikas-movva/Obsidian><svg class="feather feather-github" viewbox="0 0 24 24" fill=none height=20 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=20 xmlns=http://www.w3.org/2000/svg><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg><span class="ms-2 visually-hidden">GitHub</span></a></ul><div class="collapse navbar-collapse order-4 order-md-1"><ul class="navbar-nav main-nav me-auto order-5 order-md-2"></ul><div class="break order-6 d-md-none"></div><form class="navbar-form flex-grow-1 order-7 order-md-3"><input aria-label="Search docs..." class="form-control is-search" placeholder="Search docs..." autocomplete=off id=userinput type=search><div class="shadow bg-white rounded" id=suggestions></div></form></div></div></header><div class="wrap container" role=document><div class=content><div class="row flex-xl-nowrap"><div class="col-lg-5 col-xl-4 docs-sidebar"><nav aria-label="Main navigation" class=docs-links><h3 class=collapsible-section>main</h3><div class=collapsible-wrapper><ul class=list-unstyled><li><a class=docs-link href=https://vikas-movva-obsidian.netlify.app/docs/00-kanban-board/>00 Kanban Board</a><li><a class=docs-link href=https://vikas-movva-obsidian.netlify.app/docs/cover-letter-templates-chatgpt/>Cover Letter Templates (Chatgpt)</a><li><a class=docs-link href=https://vikas-movva-obsidian.netlify.app/docs/scrap/>Scrap</a><li><a class=docs-link href=https://vikas-movva-obsidian.netlify.app/docs/scrap.excalidraw/>Scrap.Excalidraw</a></ul></div><h3 class=collapsible-section>FFXIV</h3><div class=collapsible-wrapper><ul class=list-unstyled><li><a class=docs-link href=https://vikas-movva-obsidian.netlify.app/docs/ffxiv/t9-phase-2.excalidraw/>T9 - Phase 2.Excalidraw</a><li><a class=docs-link href=https://vikas-movva-obsidian.netlify.app/docs/ffxiv/t9-phase-2/>T9 Phase 2</a></ul></div><h3 class=collapsible-section>ML-Journey</h3><div class=collapsible-wrapper><ul class=list-unstyled><li><a class=docs-link href=https://vikas-movva-obsidian.netlify.app/docs/ml-journey/untitled/>Untitled</a></ul></div><h4 class=collapsible-section>ðŸ‘‰Fast.ai</h4><div class=collapsible-wrapper><ul class=list-unstyled><li><a class=docs-link href=https://vikas-movva-obsidian.netlify.app/docs/ml-journey/fast-ai/lesson-1/>Lesson 1</a></ul></div><h4 class=collapsible-section>ðŸ‘‰Linear Algebra</h4><div class=collapsible-wrapper><ul class=list-unstyled><li><a class=docs-link href=https://vikas-movva-obsidian.netlify.app/docs/ml-journey/linear-algebra/solving-linear-systems.excalidraw/>Solving Linear Systems.excalidraw</a></ul></div><h5 class=collapsible-section>ðŸ‘‰ðŸ‘‰Matrices</h5><div class=collapsible-wrapper><ul class=list-unstyled><li><a class=docs-link href=https://vikas-movva-obsidian.netlify.app/docs/ml-journey/linear-algebra/matrices/drawing-2022-09-10-15.04.23.excalidraw/>Drawing 2022-09-10 15.04.23.Excalidraw</a><li><a class=docs-link href=https://vikas-movva-obsidian.netlify.app/docs/ml-journey/linear-algebra/matrices/matrices/>Matrices</a><li><a class=docs-link href=https://vikas-movva-obsidian.netlify.app/docs/ml-journey/linear-algebra/matrices/matrix-operations/>Matrix Operations</a></ul></div><h5 class=collapsible-section>ðŸ‘‰ðŸ‘‰Vectors</h5><div class=collapsible-wrapper><ul class=list-unstyled><li><a class=docs-link href=https://vikas-movva-obsidian.netlify.app/docs/ml-journey/linear-algebra/vectors/basis/>Basis</a><li><a class=docs-link href=https://vikas-movva-obsidian.netlify.app/docs/ml-journey/linear-algebra/vectors/opperations-with-vectors/>Opperations With Vectors</a><li><a class=docs-link href=https://vikas-movva-obsidian.netlify.app/docs/ml-journey/linear-algebra/vectors/vector-addition-practice.excalidraw/>Vector Addition Practice.excalidraw</a><li><a class=docs-link href=https://vikas-movva-obsidian.netlify.app/docs/ml-journey/linear-algebra/vectors/vector-dot-product-practice.excalidraw/>Vector Dot Product Practice.excalidraw</a><li><a class=docs-link href=https://vikas-movva-obsidian.netlify.app/docs/ml-journey/linear-algebra/vectors/vectors/>Vectors</a></ul></div><h4 class=collapsible-section>ðŸ‘‰Statistics</h4><div class=collapsible-wrapper><ul class=list-unstyled><li><a class=docs-link href=https://vikas-movva-obsidian.netlify.app/docs/ml-journey/statistics/statistics/>Statistics</a></ul></div><h5 class=collapsible-section>ðŸ‘‰ðŸ‘‰1.1 What is Statistics</h5><div class=collapsible-wrapper><ul class=list-unstyled><li><a class=docs-link href=https://vikas-movva-obsidian.netlify.app/docs/ml-journey/statistics/1-1-what-is-statistics/1.1-what-is-statistics/>1.1 What Is Statistics</a></ul></div><h5 class=collapsible-section>ðŸ‘‰ðŸ‘‰1.2 Sampling</h5><div class=collapsible-wrapper><ul class=list-unstyled><li><a class=docs-link href=https://vikas-movva-obsidian.netlify.app/docs/ml-journey/statistics/1-2-sampling/1.2-sampling/>1.2 Sampling</a></ul></div><h3 class=collapsible-section>Projects</h3><div class=collapsible-wrapper><ul class=list-unstyled><li><a class=docs-link href=https://vikas-movva-obsidian.netlify.app/docs/projects/projects-kanban/>Projects Kanban</a></ul></div><h4 class=collapsible-section>ðŸ‘‰MyGamesList</h4><div class=collapsible-wrapper><ul class=list-unstyled><li><a class=docs-link href=https://vikas-movva-obsidian.netlify.app/docs/projects/mygameslist/outline/>Outline</a></ul></div><h4 class=collapsible-section>ðŸ‘‰Rust-NES</h4><div class=collapsible-wrapper><ul class=list-unstyled><li><a class=docs-link href=https://vikas-movva-obsidian.netlify.app/docs/projects/rust-nes/rust-nes-kanban/>Rust-NES Kanban</a></ul></div><h4 class=collapsible-section>ðŸ‘‰Rust-OS</h4><div class=collapsible-wrapper><ul class=list-unstyled><li><a class=docs-link href=https://vikas-movva-obsidian.netlify.app/docs/projects/rust-os/project-outline/>Project Outline</a></ul></div><h5 class=collapsible-section>ðŸ‘‰ðŸ‘‰Notes</h5><div class=collapsible-wrapper><ul class=list-unstyled><li><a class=docs-link href=https://vikas-movva-obsidian.netlify.app/docs/projects/rust-os/notes/00-create-a-freestanding-rust-binary/>00 Create A Freestanding Rust Binary</a><li><a class="docs-link active" href=https://vikas-movva-obsidian.netlify.app/docs/projects/rust-os/notes/01-a-minimal-rust-kernel/>01 A Minimal Rust Kernel</a></ul></div><h4 class=collapsible-section>ðŸ‘‰ml-demo</h4><div class=collapsible-wrapper><ul class=list-unstyled><li><a class=docs-link href=https://vikas-movva-obsidian.netlify.app/docs/projects/ml-demo/ml-demo-kanban/>Ml-Demo Kanban</a><li><a class=docs-link href=https://vikas-movva-obsidian.netlify.app/docs/projects/ml-demo/project-outline/>Project Outline</a><li><a class=docs-link href=https://vikas-movva-obsidian.netlify.app/docs/projects/ml-demo/rough-design.excalidraw/>Rough Design.Excalidraw</a></ul></div><h3 class=collapsible-section>Random</h3><div class=collapsible-wrapper><ul class=list-unstyled><li><a class=docs-link href=https://vikas-movva-obsidian.netlify.app/docs/random/random/>Random</a></ul></div><h4 class=collapsible-section>ðŸ‘‰CP202 Website Design</h4><div class=collapsible-wrapper><ul class=list-unstyled><li><a class=docs-link href=https://vikas-movva-obsidian.netlify.app/docs/school/cp202-website-design/00-intro/>00 Intro</a><li><a class=docs-link href=https://vikas-movva-obsidian.netlify.app/docs/school/cp202-website-design/html/>HTML</a></ul></div><h5 class=collapsible-section>ðŸ‘‰ðŸ‘‰Week 1</h5><div class=collapsible-wrapper><ul class=list-unstyled><li><a class=docs-link href=https://vikas-movva-obsidian.netlify.app/docs/school/cp202-website-design/week-1/lecture-1/>Lecture 1</a></ul></div><h5 class=collapsible-section>ðŸ‘‰ðŸ‘‰Week 2</h5><div class=collapsible-wrapper><ul class=list-unstyled><li><a class=docs-link href=https://vikas-movva-obsidian.netlify.app/docs/school/cp202-website-design/week-2/links/>Links</a><li><a class=docs-link href=https://vikas-movva-obsidian.netlify.app/docs/school/cp202-website-design/week-2/text-and-lists/>Text And Lists</a></ul></div><h4 class=collapsible-section>ðŸ‘‰CP214 Discrete Structures for Comp-Sci</h4><div class=collapsible-wrapper><ul class=list-unstyled><li><a class=docs-link href=https://vikas-movva-obsidian.netlify.app/docs/school/cp214-discrete-structures-for-comp-sci/00-intro/>00 Intro</a><li><a class=docs-link href=https://vikas-movva-obsidian.netlify.app/docs/school/cp214-discrete-structures-for-comp-sci/01-predicate-logic/>01 Predicate Logic</a><li><a class=docs-link href=https://vikas-movva-obsidian.netlify.app/docs/school/cp214-discrete-structures-for-comp-sci/01.1-propositional-logic.excalidraw/>01.1 Propositional Logic.excalidraw</a><li><a class=docs-link href=https://vikas-movva-obsidian.netlify.app/docs/school/cp214-discrete-structures-for-comp-sci/02-sets-functions-and-relations/>02 Sets, Functions, And Relations</a><li><a class=docs-link href=https://vikas-movva-obsidian.netlify.app/docs/school/cp214-discrete-structures-for-comp-sci/03-induction-and-recursive-functions/>03 Induction And Recursive Functions</a><li><a class=docs-link href=https://vikas-movva-obsidian.netlify.app/docs/school/cp214-discrete-structures-for-comp-sci/04-counting/>04 Counting</a></ul></div><h4 class=collapsible-section>ðŸ‘‰CP317 Software Eng</h4><div class=collapsible-wrapper><ul class=list-unstyled><li><a class=docs-link href=https://vikas-movva-obsidian.netlify.app/docs/school/cp317-software-eng/ch1-notes/>Ch1 Notes</a><li><a class=docs-link href=https://vikas-movva-obsidian.netlify.app/docs/school/cp317-software-eng/ch2-notes/>Ch2 Notes</a></ul></div><h4 class=collapsible-section>ðŸ‘‰CP372 Computer Networks</h4><div class=collapsible-wrapper><ul class=list-unstyled><li><a class=docs-link href=https://vikas-movva-obsidian.netlify.app/docs/school/cp372-computer-networks/assignment-1.excalidraw/>Assignment 1.Excalidraw</a></ul></div><h4 class=collapsible-section>ðŸ‘‰ML101 - Harry Potter and Medieval Culture</h4><div class=collapsible-wrapper><ul class=list-unstyled><li><a class=docs-link href=https://vikas-movva-obsidian.netlify.app/docs/school/ml101-harry-potter-and-medieval-culture/00-intro/>00 Intro</a><li><a class=docs-link href=https://vikas-movva-obsidian.netlify.app/docs/school/ml101-harry-potter-and-medieval-culture/lecture-1/>Lecture 1</a><li><a class=docs-link href=https://vikas-movva-obsidian.netlify.app/docs/school/ml101-harry-potter-and-medieval-culture/tut-1a/>TUT 1A</a><li><a class=docs-link href=https://vikas-movva-obsidian.netlify.app/docs/school/ml101-harry-potter-and-medieval-culture/tut-2/>TUT 2</a></ul></div><h3 class=collapsible-section>Templates</h3><div class=collapsible-wrapper><ul class=list-unstyled><li><a class=docs-link href=https://vikas-movva-obsidian.netlify.app/docs/templates/basic/>Basic</a><li><a class=docs-link href=https://vikas-movva-obsidian.netlify.app/docs/templates/daily-note-template/>Daily Note Template</a></ul></div></nav></div><nav aria-label="Secondary navigation" class="docs-toc d-none d-xl-block col-xl-3"><div class=page-links><h3>On this page</h3><nav id=TableOfContents><ul><li><a href=https://vikas-movva-obsidian.netlify.app/docs/projects/rust-os/notes/01-a-minimal-rust-kernel/#summary>Summary:</a><li><a href=https://vikas-movva-obsidian.netlify.app/docs/projects/rust-os/notes/01-a-minimal-rust-kernel/#the-boot-process>The Boot Process</a></li><ul><li><a href=https://vikas-movva-obsidian.netlify.app/docs/projects/rust-os/notes/01-a-minimal-rust-kernel/#firmware-standards>Firmware standards</a><li><a href=https://vikas-movva-obsidian.netlify.app/docs/projects/rust-os/notes/01-a-minimal-rust-kernel/#bios-boot>BIOS Boot</a><li><a href=https://vikas-movva-obsidian.netlify.app/docs/projects/rust-os/notes/01-a-minimal-rust-kernel/#multiboot-standard>Multiboot Standard</a></ul><li><a href=https://vikas-movva-obsidian.netlify.app/docs/projects/rust-os/notes/01-a-minimal-rust-kernel/#minimal-kernel>Minimal Kernel</a></li><ul><li><a href=https://vikas-movva-obsidian.netlify.app/docs/projects/rust-os/notes/01-a-minimal-rust-kernel/#rust-nightly>Rust Nightly</a><li><a href=https://vikas-movva-obsidian.netlify.app/docs/projects/rust-os/notes/01-a-minimal-rust-kernel/#target-specification>Target Specification</a><li><a href=https://vikas-movva-obsidian.netlify.app/docs/projects/rust-os/notes/01-a-minimal-rust-kernel/#building-the-kernel>Building the Kernel</a><li><a href=https://vikas-movva-obsidian.netlify.app/docs/projects/rust-os/notes/01-a-minimal-rust-kernel/#printing-to-screen>Printing to Screen</a></ul><li><a href=https://vikas-movva-obsidian.netlify.app/docs/projects/rust-os/notes/01-a-minimal-rust-kernel/#running-the-kernel>Running the Kernel</a></li><ul><li><a href=https://vikas-movva-obsidian.netlify.app/docs/projects/rust-os/notes/01-a-minimal-rust-kernel/#creating-a-bootimage>Creating a Bootimage</a></ul></ul></nav></div></nav><main class="docs-content col-lg-11 col-xl-9"><h1>01 A Minimal Rust Kernel</h1><h3 id=summary>Summary:</h3><h3 id=the-boot-process>The Boot Process</h3><p>On startup your computer begins to execute firmware code that is stored in motherboard ROM<p>The process goes something like this:<pre class=language-mermaid data-lang=mermaid style=background-color:#2b303b;color:#c0c5ce;><code class=language-mermaid data-lang=mermaid><span>graph LR
</span><span>	A[Power on] --> B[execute firmware code]
</span><span>	B --> C[POST]
</span><span>	C --> D[detect available RAM]
</span><span>	D --> E[preinitialize CPU and hardware]
</span><span>	E --> F[look for bootable drive] 
</span><span>	F --> G[boot OS]
</span></code></pre><p>Power on -> execute firmware code<br> -> POST -> detect available RAM -> pre-initialize CPU and hardware -> look for bootable drive -> boot OS<h4 id=firmware-standards>Firmware standards</h4><p>On a x86 CPU there are two firmware standards:<ul><li><p>Basic Input/output System or BIOS</p> <ul><li>Old and outdated standard<li>Simple to use and well supported on majority of x86 machines</ul><li><p>Unified Extensible Firmware Interface or UEFI</p> <ul><li>Modern and feature rich<li>Complex to setup</ul></ul><h4 id=bios-boot>BIOS Boot</h4><p>In order to maintain compatibility most new <a href=/docs/projects/rust-os/notes/01-a-minimal-rust-kernel#firmware-standards>UEFI</a> machines use an emulated <a href=/docs/projects/rust-os/notes/01-a-minimal-rust-kernel#firmware-standards>BIOS</a> a byproduct of this compatibility is that the CPU is put into ==real mode== which is a 16bit compatibility mode<p>Updated boot process<pre class=language-mermaid data-lang=mermaid style=background-color:#2b303b;color:#c0c5ce;><code class=language-mermaid data-lang=mermaid><span>graph LR
</span><span>	A[Power on] --> B[execute firmware code]
</span><span>	B --> C[POST]
</span><span>	C --> D[detect available RAM]
</span><span>	D --> E[preinitialize CPU and hardware]
</span><span>	E --> F[look for bootable drive] 
</span><span>	F --> G[run bootloader]
</span><span>	G --> H[start OS]
</span></code></pre><p>Power on -> execute firmware code<br> -> POST -> detect available RAM -> pre-initialize CPU and hardware -> look for bootable drive -> run bootloader -> ?<p>The bootloader is a 512 byte portion of executable code that is stored at the beginning of the disk<p>Most of the time the bootloader is larger than 512 bytes so it is broken into two parts where the first part is 512 bytes and loads the second part<p>The bootloader has some key roles:<ul><li>Determine the location of the kernel image on the disk and load it into memory<li>Switch the CPU from 16bit real mode to 32bit protected mode then to 64bit long mode where 64-bit registers<sup class=footnote-reference><a href=#1>1</a></sup> and the complete main memory are available<li>Query information (Ex. Memory map<sup class=footnote-reference><a href=#2>2</a></sup>) from the BIOS and pass it to the OS kernel</ul><p>Writing a bootloader is annoying and and written in assembly ðŸ¤® however the program <a href=https://github.com/rust-osdev/bootimage>bootimage</a> can automatically prepend a bootloader to a kernel<h4 id=multiboot-standard>Multiboot Standard</h4><p>Multiboot is a standard created by the Free Software Foundation in order to avoid having every OS from implementing its own bootloader that is only compatible with itself<p>The standard defines an interface between the bootloader and the operating system, so that any Multiboot-compliant bootloader can load any Multiboot-compliant OS<ul><li>Reference implementation: <a href=https://www.gnu.org/software/grub/>GNU GRUB</a> <ul><li>Most popular bootloader for Linux systems</ul></ul><p>In order to make the Multiboot-compliant a Multiboot-header needs to be inserted at the beginning of the kernel file.<p>This does makes it easy to boot an OS from GRUB but there are some problems with this method too<ul><li>Only 32bit protected mode is supported which means that the CPU configuration to switch to 64bit long mode still needs to be done<li>They are designed to make the bootloader simple instead of the kernel<li>Documentation for both GRUB and Multiboot is sparse at best<li>GRUB needs to be installed on the host system to create a bootable disk image from the kernel file which makes development on Windows or Mac difficult</ul><h3 id=minimal-kernel>Minimal Kernel</h3><p>Preliminary goal: create a disk image that prints "Hello world" when booted.<p>In order to achieve this <a href=/docs/projects/rust-os/notes/00-create-a-freestanding-rust-binary>the freestanding Rust binary</a> needs to be extended.<p>In <a href=/docs/projects/rust-os/notes/00-create-a-freestanding-rust-binary>Rust binary</a> cargo was used to build the binary however cargo builds for the host system by default and a kernel that runs on top of Windows/Mac doesn't make sense<h4 id=rust-nightly>Rust Nightly</h4><p>There are three different channels of Rust: stable, beta, nightly<ul><li>Stable: tested features<li>Beta: new features that have yet to be tested<li>Nightly: experimental features</ul><p>The nightly compiler allows you to opt-in to experimental features such as <code>!asm</code> macro for inline asm<p><code>rustup</code> can be used to easily install / update all three channels side-by-side.<h4 id=target-specification>Target Specification</h4><p>Cargo supports different target systems through the <code>--target</code> parameter<p>The target is described by a triple target format -> <code>CPU-vendor-OS-ABI</code> Ex. <code>x86_64-unknown-linux-gnu</code><p>because there is no underlaying target none of the default targets are useable but Rust allows you to make your own from a JSON file:<pre class=language-json data-lang=json style=background-color:#2b303b;color:#c0c5ce;><code class=language-json data-lang=json><span>{
</span><span>"</span><span style=color:#a3be8c;>llvm-target</span><span>": "</span><span style=color:#a3be8c;>x86_64-unknown-none</span><span>", </span><span style=color:#65737e;>// for running on bare metal
</span><span>"</span><span style=color:#a3be8c;>data-layout</span><span>": "</span><span style=color:#a3be8c;>e-m:e-i64:64-f80:128-n8:16:32:64-s128</span><span>",
</span><span>"</span><span style=color:#a3be8c;>arch</span><span>": "</span><span style=color:#a3be8c;>x86_64</span><span>",
</span><span>"</span><span style=color:#a3be8c;>target-endian</span><span>": "</span><span style=color:#a3be8c;>little</span><span>",
</span><span>"</span><span style=color:#a3be8c;>target-pointer-width</span><span>": "</span><span style=color:#a3be8c;>64</span><span>",
</span><span>"</span><span style=color:#a3be8c;>target-c-int-width</span><span>": "</span><span style=color:#a3be8c;>32</span><span>",
</span><span>"</span><span style=color:#a3be8c;>os</span><span>": "</span><span style=color:#a3be8c;>none</span><span>", </span><span style=color:#65737e;>// for bare metal
</span><span>"</span><span style=color:#a3be8c;>executables</span><span>": </span><span style=color:#d08770;>true</span><span>,
</span><span>"</span><span style=color:#a3be8c;>linker-flavor</span><span>": "</span><span style=color:#a3be8c;>ld.lld</span><span>",
</span><span>"</span><span style=color:#a3be8c;>linker</span><span>": "</span><span style=color:#a3be8c;>rust-lld</span><span>", </span><span style=color:#65737e;>// lld linker that comes with rust
</span><span>"</span><span style=color:#a3be8c;>panic-strategy</span><span>": "</span><span style=color:#a3be8c;>abort</span><span>", </span><span style=color:#65737e;>// has the same effect as editing cargo.toml
</span><span>"</span><span style=color:#a3be8c;>disable-redzone</span><span>": </span><span style=color:#d08770;>true</span><span>,
</span><span>"</span><span style=color:#a3be8c;>features</span><span>": "</span><span style=color:#a3be8c;>-mmx,-sse,+soft-float</span><span>" </span><span style=color:#65737e;>// -: disable, +: enable
</span><span>}
</span></code></pre><h4 id=building-the-kernel>Building the Kernel</h4><p>In order to build the kernel we need to recompile the <code>core</code> library to the target(<code>x86_64-unknown-none</code>)<p>in order to do this we need to add the following:<br> <code>.cargo/config.toml</code>:<pre class=language-toml data-lang=toml style=background-color:#2b303b;color:#c0c5ce;><code class=language-toml data-lang=toml><span>[unstable]
</span><span style=color:#bf616a;>build-std </span><span>= ["</span><span style=color:#a3be8c;>Core</span><span>", "</span><span style=color:#a3be8c;>Compiler_builtins</span><span>"]
</span></code></pre><p>in order to build the kernel run:<pre class=language-shell data-lang=shell style=background-color:#2b303b;color:#c0c5ce;><code class=language-shell data-lang=shell><span>cargo build --target x86_64-rust-os.json
</span></code></pre><h5 id=memory-related-intrinsics>Memory Related Intrinsics</h5><p>The Rust compiler assumes that certain built-in functions are available for all systems.<p>Normally these are provided by the <code>C</code> library of the system. Since that is not available we can add the following to enable some of these functions:<br> <code>.cargo/config.toml</code><pre class=language-toml data-lang=toml style=background-color:#2b303b;color:#c0c5ce;><code class=language-toml data-lang=toml><span>[unstable]
</span><span style=color:#bf616a;>build-std-features </span><span>= ["</span><span style=color:#a3be8c;>Compiler-builtins-mem</span><span>"]
</span><span style=color:#bf616a;>build-std </span><span>= ["</span><span style=color:#a3be8c;>Core</span><span>", "</span><span style=color:#a3be8c;>Compiler_builtins</span><span>"]
</span></code></pre><ul><li>this is only available in the nightly build of Rust</ul><p>In order to not type <code>--target x86_64-rust-os.json</code> in the command-line every time we can add:<br> <code>.cargo/config.toml</code><pre class=language-toml data-lang=toml style=background-color:#2b303b;color:#c0c5ce;><code class=language-toml data-lang=toml><span>[build]
</span><span style=color:#bf616a;>target </span><span>= "</span><span style=color:#a3be8c;>X86_64-rust-os.json</span><span>"
</span></code></pre><ul><li>this tells cargo to use the above as target whenever there is no <code>--target</code> argument</ul><h4 id=printing-to-screen>Printing to Screen</h4><p>The easiest way to print to the screen is to use the <a href=https://en.wikipedia.org/wiki/VGA_text_mode>VGA buffer</a>.<p>The VGA buffer is a section in memory mapped to the VGA hardware that contains the contents displayed on the screen. it normally consists of 25 lines that each contain 80 character cells. Each character cell displays an ASCII chracter with some foreground and background colours.<p>An example output:<br> <img src=https://upload.wikimedia.org/wikipedia/commons/6/6d/Codepage-737.png><p>Implementation of the kernel displaying "Hello world!" on start:<pre class=language-Rust data-lang=Rust style=background-color:#2b303b;color:#c0c5ce;><code class=language-Rust data-lang=Rust><span style=color:#b48ead;>static </span><span style=color:#d08770;>HELLO</span><span>: &[</span><span style=color:#b48ead;>u8</span><span>] = </span><span style=color:#b48ead;>b</span><span>"</span><span style=color:#a3be8c;>Hello World!</span><span>";
</span><span>
</span><span>#[</span><span style=color:#bf616a;>no_mangle</span><span>]
</span><span style=color:#b48ead;>pub extern </span><span>"</span><span style=color:#a3be8c;>C</span><span>" </span><span style=color:#b48ead;>fn </span><span style=color:#8fa1b3;>_start</span><span>() -> ! {
</span><span>	</span><span style=color:#b48ead;>let</span><span> vga_buffer = </span><span style=color:#d08770;>0xb800 </span><span>as </span><span style=color:#b48ead;>*mut u8</span><span>;
</span><span>
</span><span>	</span><span style=color:#b48ead;>for </span><span>(i, &byte) in </span><span style=color:#d08770;>HELLO</span><span>.</span><span style=color:#96b5b4;>iter</span><span>().</span><span style=color:#96b5b4;>enumerate</span><span>(){
</span><span>		</span><span style=color:#b48ead;>unsafe</span><span>{
</span><span>			*vga_buffer.</span><span style=color:#96b5b4;>offset</span><span>(i as </span><span style=color:#b48ead;>isize </span><span>*</span><span style=color:#d08770;>2</span><span>) = byte;
</span><span>			*vga_buffer.</span><span style=color:#96b5b4;>offset</span><span>(i as </span><span style=color:#b48ead;>isize </span><span>*</span><span style=color:#d08770;>2 </span><span>+ </span><span style=color:#d08770;>1</span><span>) = </span><span style=color:#d08770;>0xb</span><span>;
</span><span>		}
</span><span>	}
</span><span>
</span><span>	</span><span style=color:#b48ead;>loop</span><span>{}
</span><span>
</span><span>}
</span></code></pre><ul><li>cast the integer <code>0xb8000</code> into a raw pointer<li>iterate over the bytes of the static byte string <code>HELLO</code><li>use enumerate in order to get the running variable <code>i</code><li>use the offset method to write the string byte and corresponding colour byte</ul><blockquote><p>==Note==: there is the use of the <code>unsafe</code> keyword this is <strong>temporary and not the point of using rust</strong></blockquote><h3 id=running-the-kernel>Running the Kernel</h3><p>There are two options for running the kernel<ul><li>Using a virtual machine such as QEMU<li>Boot it on real hardware using a USB</ul><h4 id=creating-a-bootimage>Creating a Bootimage</h4><p>To turn a compiled kernel into a bootable disk image we need to link it with a boot loader<p>In order to do so add the following:<br> <code>Cargo.toml</code><pre class=language-toml data-lang=toml style=background-color:#2b303b;color:#c0c5ce;><code class=language-toml data-lang=toml><span>[dependencies]
</span><span style=color:#bf616a;>bootloader </span><span>= "</span><span style=color:#a3be8c;>0.9.8</span><span>"
</span></code></pre><p>then run:<pre class=language-shell data-lang=shell style=background-color:#2b303b;color:#c0c5ce;><code class=language-shell data-lang=shell><span>cargo install bootimage
</span><span>rustup component add llvm-tools-preview
</span><span>cargo bootimage
</span></code></pre><p>What does the bootimage tool really do?<ul><li>compiles kernel to an <a href=https://en.wikipedia.org/wiki/Executable_and_Linkable_Format>ELF</a> file<li>compiles bootloader dependency as a standalone executable<li>links the bytes of the kernel ELF file to the bootloader</ul><div class=footnote-definition id=1><sup class=footnote-definition-label>1</sup><p>registers are temporary storage locations in the processor.<br> <sup class=footnote-reference><a href=#2>2</a></sup>: A data structure that indicates how memory is laid out</div><div class=docs-graph id=graph></div></main></div></div></div><script integrity="sha512-XHDcSyqhOoO2ocB7sKOCJEkUjw/pQCJViP1ynpy+EGh/LggzrP6U/V3a++LQTnZT7sCQKeHRyWHfhN2afjXjCg==" crossorigin=anonymous referrerpolicy=no-referrer src=https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js></script><script defer src=https://vikas-movva-obsidian.netlify.app/js/graph_info.js></script><script defer src=https://vikas-movva-obsidian.netlify.app/js/graph.js></script><script defer src=https://vikas-movva-obsidian.netlify.app/js/settings.js></script><script defer src=https://vikas-movva-obsidian.netlify.app/js/main.js></script><script defer src=https://vikas-movva-obsidian.netlify.app/plugins/elasticlunr.min.js></script><script defer src=https://vikas-movva-obsidian.netlify.app/search_index.en.js></script><script defer src=https://vikas-movva-obsidian.netlify.app/js/search.js></script>